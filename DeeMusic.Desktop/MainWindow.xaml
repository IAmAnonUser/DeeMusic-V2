<Window x:Class="DeeMusic.Desktop.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:viewmodels="clr-namespace:DeeMusic.Desktop.ViewModels"
        xmlns:views="clr-namespace:DeeMusic.Desktop.Views"
        mc:Ignorable="d"
        Title="DeeMusic v2.0.4" 
        Height="900" 
        Width="1280"
        MinHeight="700"
        MinWidth="1000"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource MaterialDesignPaper}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="13"
        TextOptions.TextFormattingMode="Ideal"
        TextOptions.TextRenderingMode="ClearType"
        RenderOptions.BitmapScalingMode="HighQuality"
        UseLayoutRounding="True"
        SnapsToDevicePixels="True"
        FontFamily="{DynamicResource MaterialDesignFont}"
        WindowStyle="None"
        AllowsTransparency="True"
        ResizeMode="CanResize"
        Icon="Resources/app-icon.ico">
    
    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="0"
                     ResizeBorderThickness="5"
                     CornerRadius="8"
                     GlassFrameThickness="0"
                     UseAeroCaptionButtons="False"/>
    </WindowChrome.WindowChrome>
    
    <Window.Resources>
        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <!-- DataTemplates to map ViewModels to Views -->
        <DataTemplate DataType="{x:Type viewmodels:SearchViewModel}">
            <views:SearchView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewmodels:QueueViewModel}">
            <views:QueueView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewmodels:SettingsViewModel}">
            <views:SettingsView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewmodels:AlbumDetailViewModel}">
            <views:AlbumDetailView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewmodels:ArtistDetailViewModel}">
            <views:ArtistDetailView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewmodels:PlaylistDetailViewModel}">
            <views:PlaylistDetailView/>
        </DataTemplate>
    </Window.Resources>
    
    <Border Background="{DynamicResource MaterialDesignPaper}"
            BorderBrush="{DynamicResource PrimaryHueMidBrush}"
            BorderThickness="1"
            CornerRadius="8">
        
        <Grid x:Name="RootGrid">
            <Grid.RowDefinitions>
                <RowDefinition Height="60"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- Top Bar -->
            <Border Grid.Row="0" 
                    Background="{DynamicResource MaterialDesignCardBackground}"
                    CornerRadius="8,8,0,0"
                    MouseLeftButtonDown="TopBar_MouseLeftButtonDown">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Logo and Search Box -->
                    <Grid Grid.Column="0" Margin="16,8,16,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- Modern Logo -->
                        <StackPanel Grid.Column="0" 
                                   Orientation="Horizontal" 
                                   VerticalAlignment="Center"
                                   Margin="0,0,20,0">
                            <!-- Stylized "D" with gradient background -->
                            <Border Width="32" 
                                   Height="32" 
                                   CornerRadius="8"
                                   VerticalAlignment="Center">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#6366F1" Offset="0"/>
                                        <GradientStop Color="#8B5CF6" Offset="1"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                                <TextBlock Text="D" 
                                          FontSize="20" 
                                          FontWeight="Bold"
                                          Foreground="White"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"/>
                            </Border>
                            
                            <!-- Brand Name -->
                            <StackPanel Orientation="Horizontal" 
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0">
                                <TextBlock FontSize="16" 
                                          FontWeight="Bold"
                                          VerticalAlignment="Center">
                                    <TextBlock.Foreground>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                            <GradientStop Color="#6366F1" Offset="0"/>
                                            <GradientStop Color="#8B5CF6" Offset="1"/>
                                        </LinearGradientBrush>
                                    </TextBlock.Foreground>
                                    <Run Text="Dee"/>
                                </TextBlock>
                                <TextBlock Text="Music" 
                                          FontSize="16" 
                                          FontWeight="Bold"
                                          Foreground="{DynamicResource MaterialDesignBody}"
                                          VerticalAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>
                        
                        <TextBox Grid.Column="1"
                                 x:Name="SearchBox"
                                 materialDesign:HintAssist.Hint="Search tracks, albums, artists, playlists..."
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                 VerticalAlignment="Center"
                                 FontSize="14"
                                 Padding="12,8"
                                 Text="{Binding SearchViewModel.SearchQuery, UpdateSourceTrigger=PropertyChanged}">
                            <TextBox.InputBindings>
                                <KeyBinding Key="Enter" Command="{Binding SearchViewModel.SearchCommand}"/>
                            </TextBox.InputBindings>
                        </TextBox>
                        
                        <Button Grid.Column="2"
                                Style="{StaticResource MaterialDesignIconButton}"
                                Width="40"
                                Height="40"
                                Margin="8,0,0,0"
                                Command="{Binding SearchViewModel.SearchCommand}"
                                ToolTip="Search">
                            <materialDesign:PackIcon Kind="Magnify" Width="20" Height="20"/>
                        </Button>
                    </Grid>
                    
                    <!-- Right Side Buttons -->
                    <StackPanel Grid.Column="1" 
                                Orientation="Horizontal"
                                Margin="0,0,8,0">
                        
                        <!-- Theme Toggle -->
                        <Button Style="{StaticResource MaterialDesignIconButton}"
                                Width="48"
                                Height="48"
                                Command="{Binding ToggleThemeCommand}"
                                ToolTip="Toggle Theme">
                            <materialDesign:PackIcon Kind="Brightness6" Width="24" Height="24"/>
                        </Button>
                        
                        <!-- Settings Button -->
                        <Button Style="{StaticResource MaterialDesignIconButton}"
                                Width="48"
                                Height="48"
                                Click="SettingsButton_Click"
                                ToolTip="Settings">
                            <materialDesign:PackIcon Kind="Cog" Width="24" Height="24"/>
                        </Button>
                        
                        <!-- Window Controls -->
                        <Button Style="{StaticResource MaterialDesignIconButton}"
                                Width="48"
                                Height="48"
                                Click="MinimizeButton_Click"
                                ToolTip="Minimize">
                            <materialDesign:PackIcon Kind="WindowMinimize" Width="20" Height="20"/>
                        </Button>
                        
                        <Button Style="{StaticResource MaterialDesignIconButton}"
                                Width="48"
                                Height="48"
                                Click="MaximizeButton_Click"
                                ToolTip="Maximize">
                            <materialDesign:PackIcon Kind="WindowMaximize" Width="20" Height="20"/>
                        </Button>
                        
                        <Button Style="{StaticResource MaterialDesignIconButton}"
                                Width="48"
                                Height="48"
                                Click="CloseButton_Click"
                                ToolTip="Close">
                            <materialDesign:PackIcon Kind="Close" Width="20" Height="20"/>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
            
            <!-- Main Content Area with Queue Panel -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="320"/>
                </Grid.ColumnDefinitions>
                
                <!-- Main Content (Search/Browse/Detail Views) -->
                <ContentControl Grid.Column="0" Content="{Binding CurrentView}"/>
                
                <!-- Download Queue Panel -->
                <Border Grid.Column="1"
                        Background="{DynamicResource MaterialDesignCardBackground}"
                        BorderBrush="{DynamicResource MaterialDesignDivider}"
                        BorderThickness="1,0,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Queue Header -->
                        <Border Grid.Row="0" 
                                Background="{DynamicResource MaterialDesignToolBarBackground}"
                                Padding="16,12">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Grid.Row="0"
                                          Text="Download Queue"
                                          FontSize="16"
                                          FontWeight="SemiBold"/>
                                
                                <StackPanel Grid.Row="1" 
                                           Orientation="Horizontal" 
                                           Margin="0,8,0,0">
                                    <Button Content="Clear All"
                                            Style="{StaticResource MaterialDesignFlatButton}"
                                            Height="28"
                                            Padding="8,4"
                                            FontSize="11"
                                            Command="{Binding QueueViewModel.ClearAllCommand}"
                                            Margin="0,0,4,0"/>
                                    <Button Content="Clear Completed"
                                            Style="{StaticResource MaterialDesignFlatButton}"
                                            Height="28"
                                            Padding="8,4"
                                            FontSize="11"
                                            Command="{Binding QueueViewModel.ClearCompletedCommand}"
                                            Margin="0,0,4,0"/>
                                    <Button Content="Retry Failed"
                                            Style="{StaticResource MaterialDesignFlatButton}"
                                            Height="28"
                                            Padding="8,4"
                                            FontSize="11"
                                            Command="{Binding QueueViewModel.RetryFailedCommand}"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Queue Stats -->
                        <Border Grid.Row="1" Padding="16,8">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <!-- Stats Summary -->
                                <StackPanel Grid.Row="0" Margin="0,0,0,8">
                                    <TextBlock FontSize="12" Opacity="0.7">
                                        <Run Text="Total: "/>
                                        <Run Text="{Binding QueueViewModel.TotalTracksInQueue, Mode=OneWay}" FontWeight="SemiBold"/>
                                        <Run Text=" | Completed: "/>
                                        <Run Text="{Binding QueueViewModel.CompletedTracksInQueue, Mode=OneWay}" FontWeight="SemiBold"/>
                                    </TextBlock>
                                </StackPanel>
                                
                                <!-- Queue Items List -->
                                <ScrollViewer Grid.Row="1" 
                                            VerticalScrollBarVisibility="Auto"
                                            HorizontalScrollBarVisibility="Disabled">
                                    <ItemsControl ItemsSource="{Binding QueueViewModel.QueueItems}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Margin="0,0,0,8"
                                                       Padding="8"
                                                       BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                       BorderThickness="1"
                                                       CornerRadius="4">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="Background" Value="{DynamicResource MaterialDesignCardBackground}"/>
                                                            <Style.Triggers>
                                                                <!-- Failed (red) -->
                                                                <DataTrigger Binding="{Binding IsFailed}" Value="True">
                                                                    <Setter Property="Background" Value="#FEE2E2"/>
                                                                </DataTrigger>
                                                                <!-- Completed (green) -->
                                                                <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                                                                    <Setter Property="Background" Value="#E8F5E9"/>
                                                                </DataTrigger>
                                                                <!-- Partial success (orange) - LAST so it overrides green -->
                                                                <DataTrigger Binding="{Binding IsPartialSuccess}" Value="True">
                                                                    <Setter Property="Background" Value="#FEF3C7"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                        </Grid.RowDefinitions>
                                                        
                                                        <!-- Track Info -->
                                                        <TextBlock Grid.Row="0" Grid.Column="0"
                                                                  Text="{Binding Title}"
                                                                  FontWeight="SemiBold"
                                                                  FontSize="12"
                                                                  TextTrimming="CharacterEllipsis"/>
                                                        
                                                        <TextBlock Grid.Row="1" Grid.Column="0"
                                                                  Text="{Binding Artist}"
                                                                  FontSize="11"
                                                                  Opacity="0.7"
                                                                  TextTrimming="CharacterEllipsis"
                                                                  Margin="0,2,0,0"/>
                                                        
                                                        <!-- Track Progress for Albums/Playlists -->
                                                        <TextBlock Grid.Row="1" Grid.Column="0"
                                                                  Text="{Binding TrackProgressText}"
                                                                  FontSize="10"
                                                                  Foreground="#3B82F6"
                                                                  FontWeight="Medium"
                                                                  Margin="0,14,0,4"
                                                                  Visibility="{Binding IsAlbumOrPlaylist, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                        
                                                        <!-- Warning Icon with Popup (right side) -->
                                                        <materialDesign:PopupBox Grid.Row="0" Grid.Column="1" Grid.RowSpan="2"
                                                                                PlacementMode="BottomAndAlignRightEdges"
                                                                                StaysOpen="False"
                                                                                VerticalAlignment="Center"
                                                                                Margin="4,0,0,0"
                                                                                ToolTip="Click to see error details"
                                                                                Visibility="{Binding ShowErrorButton, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                            <materialDesign:PopupBox.ToggleContent>
                                                                <materialDesign:PackIcon Width="18" Height="18">
                                                                    <materialDesign:PackIcon.Style>
                                                                        <Style TargetType="materialDesign:PackIcon">
                                                                            <Setter Property="Kind" Value="AlertCircle"/>
                                                                            <Setter Property="Foreground" Value="#EF4444"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding IsPartialSuccess}" Value="True">
                                                                                    <Setter Property="Kind" Value="AlertCircleOutline"/>
                                                                                    <Setter Property="Foreground" Value="#F59E0B"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </materialDesign:PackIcon.Style>
                                                                </materialDesign:PackIcon>
                                                            </materialDesign:PopupBox.ToggleContent>
                                                            <materialDesign:PopupBox.PopupContent>
                                                                <Border Background="{DynamicResource MaterialDesignPaper}"
                                                                       Padding="12"
                                                                       MaxWidth="250"
                                                                       CornerRadius="6">
                                                                    <StackPanel>
                                                                        <TextBlock FontWeight="SemiBold" 
                                                                                  FontSize="13"
                                                                                  Margin="0,0,0,6"
                                                                                  Foreground="{DynamicResource MaterialDesignBody}">
                                                                            <TextBlock.Style>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Setter Property="Text" Value="Download Failed"/>
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding IsPartialSuccess}" Value="True">
                                                                                            <Setter Property="Text" Value="Partial Download"/>
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </TextBlock.Style>
                                                                        </TextBlock>
                                                                        <TextBlock Text="{Binding ErrorSummary}" 
                                                                                  TextWrapping="Wrap"
                                                                                  FontSize="11"
                                                                                  Foreground="{DynamicResource MaterialDesignBody}"/>
                                                                    </StackPanel>
                                                                </Border>
                                                            </materialDesign:PopupBox.PopupContent>
                                                        </materialDesign:PopupBox>
                                                        
                                                        <!-- Progress Bar -->
                                                        <ProgressBar Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                                                    Height="4"
                                                                    Value="{Binding Progress}"
                                                                    Maximum="100"
                                                                    Margin="0,4,0,0"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                                
                                <!-- Empty State -->
                                <TextBlock Grid.Row="1"
                                          Text="No downloads in queue"
                                          FontSize="13"
                                          Opacity="0.5"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"
                                          Visibility="{Binding QueueViewModel.IsQueueEmpty, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Border>
</Window>
